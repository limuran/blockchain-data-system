                <button class="connect-btn" onclick="disconnectWallet()" style="background: #ff6b6b; padding: 8px 16px;">
                    断开连接
                </button>
            `;
        }

        // 加载用户余额
        async function loadUserBalances() {
            if (!provider || !userAddress) return;
            
            try {
                // ETH 余额
                const ethBalance = await provider.getBalance(userAddress);
                const ethFormatted = parseFloat(ethers.formatEther(ethBalance)).toFixed(4);
                
                // USDT 余额
                let usdtFormatted = "0.00";
                try {
                    const usdtContract = new ethers.Contract(CONFIG.USDT_CONTRACT_ADDRESS, USDT_ABI, provider);
                    const usdtBalance = await usdtContract.balanceOf(userAddress);
                    const decimals = await usdtContract.decimals();
                    usdtFormatted = parseFloat(ethers.formatUnits(usdtBalance, decimals)).toFixed(2);
                } catch (e) {
                    console.log('USDT 余额查询失败:', e);
                }
                
                // 更新 UI
                const balanceInfo = document.getElementById('balanceInfo');
                if (balanceInfo) {
                    balanceInfo.innerHTML = `${ethFormatted} ETH | ${usdtFormatted} USDT`;
                }
                
            } catch (error) {
                console.log('余额查询失败:', error);
            }
        }

        // 断开钱包连接
        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            userAddress = null;
            ensName = null;
            ensAvatar = null;
            
            const walletInfo = document.getElementById('walletInfo');
            walletInfo.innerHTML = '<button class="connect-btn" onclick="connectWallet()">连接钱包</button>';
            
            showToast('钱包已断开连接', 'success');
        }

        // 按钮加载状态控制
        function setButtonLoading(buttonElement, loading) {
            if (loading) {
                buttonElement.classList.add('loading');
                buttonElement.disabled = true;
            } else {
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
            }
        }

        // 直接转账
        async function sendDirectTransaction() {
            if (!signer) {
                showToast('请先连接钱包', 'error');
                return;
            }

            const button = event.target;
            setButtonLoading(button, true);

            try {
                showProgress('ETH 转账进行中...');
                updateProgress(1, 'active', 25);
                
                const address = document.getElementById('directAddress').value.trim();
                const amount = document.getElementById('directAmount').value;
                const data = document.getElementById('directData').value;
                
                // 验证输入
                if (!address || !ethers.isAddress(address)) {
                    throw new Error('请输入有效的以太坊地址');
                }
                
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('请输入有效的转账金额');
                }
                
                if (!data.trim()) {
                    throw new Error('请输入要上链的数据');
                }
                
                updateProgress(2, 'active', 50);
                
                // 检查余额
                const balance = await provider.getBalance(userAddress);
                const amountWei = ethers.parseEther(amount);
                const gasEstimate = ethers.parseEther("0.001");
                
                if (balance < (amountWei + gasEstimate)) {
                    throw new Error('ETH 余额不足');
                }
                
                // 编码数据
                const encodedData = ethers.hexlify(ethers.toUtf8Bytes(data));
                
                // 估算 gas
                const gasLimit = await provider.estimateGas({
                    to: address,
                    value: amountWei,
                    data: encodedData
                });
                
                const tx = await signer.sendTransaction({
                    to: address,
                    value: amountWei,
                    data: encodedData,
                    gasLimit: gasLimit * 120n / 100n // 增加 20% 的 gas 缓冲
                });
                
                currentTransaction = tx;
                updateProgress(3, 'active', 75);
                
                const receipt = await tx.wait();
                updateProgress(4, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('✅ ETH 转账成功！', 'success');
                    
                    // 添加到数据列表
                    addToDataList({
                        type: 'ETH转账',
                        data: data,
                        hash: tx.hash,
                        amount: amount + ' ETH',
                        timestamp: new Date().toLocaleString(),
                        gasUsed: receipt.gasUsed.toString()
                    });
                    
                    // 清空表单
                    document.getElementById('directData').value = '';
                    
                    // 更新余额
                    loadUserBalances();
                }, 1000);
                
            } catch (error) {
                updateProgress(1, 'failed', 0);
                setTimeout(() => {
                    hideProgress();
                    showToast('转账失败: ' + error.message, 'error');
                }, 1000);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // USDT 转账
        async function sendUSDTTransaction() {
            if (!signer) {
                showToast('请先连接钱包', 'error');
                return;
            }

            const button = event.target;
            setButtonLoading(button, true);

            try {
                showProgress('USDT 转账进行中...');
                updateProgress(1, 'active', 25);
                
                const address = document.getElementById('usdtAddress').value.trim();
                const amount = document.getElementById('usdtAmount').value;
                const data = document.getElementById('usdtData').value;
                const tokenType = document.getElementById('tokenSelect').value;
                
                // 验证输入
                if (!address || !ethers.isAddress(address)) {
                    throw new Error('请输入有效的以太坊地址');
                }
                
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('请输入有效的转账金额');
                }
                
                updateProgress(2, 'active', 50);
                
                let tokenAddress = CONFIG.USDT_CONTRACT_ADDRESS;
                let decimals = 6;
                
                const tokenContract = new ethers.Contract(tokenAddress, USDT_ABI, signer);
                
                // 检查代币余额
                const balance = await tokenContract.balanceOf(userAddress);
                const amountInWei = ethers.parseUnits(amount, decimals);
                
                if (balance < amountInWei) {
                    throw new Error(`${tokenType} 余额不足`);
                }
                
                // 估算 gas
                let gasLimit;
                try {
                    gasLimit = await tokenContract.transfer.estimateGas(address, amountInWei);
                } catch (e) {
                    gasLimit = 100000n;
                }
                
                const tx = await tokenContract.transfer(address, amountInWei, {
                    gasLimit: gasLimit * 120n / 100n
                });
                
                currentTransaction = tx;
                updateProgress(3, 'active', 75);
                
                const receipt = await tx.wait();
                updateProgress(4, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast(`✅ ${tokenType} 转账成功！`, 'success');
                    
                    // 添加到数据列表
                    addToDataList({
                        type: tokenType + '转账',
                        data: data || '转账数据',
                        hash: tx.hash,
                        amount: amount + ' ' + tokenType,
                        timestamp: new Date().toLocaleString(),
                        gasUsed: receipt.gasUsed.toString()
                    });
                    
                    // 清空表单
                    document.getElementById('usdtData').value = '';
                    
                    // 更新余额
                    loadUserBalances();
                }, 1000);
                
            } catch (error) {
                updateProgress(1, 'failed', 0);
                setTimeout(() => {
                    hideProgress();
                    showToast('USDT 转账失败: ' + error.message, 'error');
                }, 1000);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // 部署合约
        async function deployContract() {
            showToast('合约部署功能需要实际的合约字节码，当前为演示模式', 'info');
            
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('合约部署中...');
            updateProgress(1, 'active', 25);
            
            // 模拟部署过程
            setTimeout(() => {
                updateProgress(2, 'active', 50);
            }, 1000);
            
            setTimeout(() => {
                updateProgress(3, 'active', 75);
            }, 2000);
            
            setTimeout(() => {
                updateProgress(4, 'completed', 100);
                const mockAddress = "0x" + Math.random().toString(16).substr(2, 40);
                document.getElementById('contractAddress').value = mockAddress;
                
                setTimeout(() => {
                    hideProgress();
                    showToast('✅ 合约部署成功！（演示模式）', 'success');
                    setButtonLoading(button, false);
                }, 500);
            }, 3000);
        }

        // 存储数据到合约
        async function storeDataInContract() {
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('写入合约数据中...');
            updateProgress(1, 'active', 25);
            
            const data = document.getElementById('contractData').value.trim();
            const dataType = document.getElementById('dataType').value;
            
            if (!data) {
                hideProgress();
                showToast('请输入要存储的数据', 'error');
                setButtonLoading(button, false);
                return;
            }
            
            // 模拟合约写入
            setTimeout(() => {
                updateProgress(2, 'active', 50);
            }, 500);
            
            setTimeout(() => {
                updateProgress(3, 'active', 75);
            }, 1500);
            
            setTimeout(() => {
                updateProgress(4, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('✅ 数据写入成功！（演示模式）', 'success');
                    
                    // 添加到数据列表
                    const mockTxHash = "0x" + Math.random().toString(16).substr(2, 64);
                    addToDataList({
                        type: '合约数据（演示）',
                        data: data,
                        hash: mockTxHash,
                        contract: document.getElementById('contractAddress').value || 'demo-contract',
                        timestamp: new Date().toLocaleString(),
                        gasUsed: '50000'
                    });
                    
                    // 清空表单
                    document.getElementById('contractData').value = '';
                    setButtonLoading(button, false);
                }, 500);
            }, 2500);
        }

        // 查询数据（简化版）
        async function queryData() {
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('查询数据中...');
            updateProgress(1, 'active', 50);
            
            // 模拟查询
            setTimeout(() => {
                updateProgress(2, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('查询完成！', 'success');
                    
                    // 显示演示数据
                    displayDemoResults();
                    setButtonLoading(button, false);
                }, 500);
            }, 1500);
        }

        // The Graph 查询
        async function queryTheGraph() {
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('执行 GraphQL 查询...');
            updateProgress(1, 'active', 50);
            
            // 模拟查询
            setTimeout(() => {
                updateProgress(2, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('The Graph 查询成功！', 'success');
                    
                    // 显示演示数据
                    displayDemoResults();
                    setButtonLoading(button, false);
                }, 500);
            }, 2000);
        }

        // 显示演示结果
        function displayDemoResults() {
            const dataList = document.getElementById('dataList');
            dataList.innerHTML = `
                <h3>📊 查询结果</h3>
                <div class="data-item">
                    <h3>🔗 合约数据记录</h3>
                    <p><strong>数据:</strong> 演示数据：用户注册信息</p>
                    <p><strong>时间:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>区块:</strong> 12345678</p>
                    <p><strong>交易哈希:</strong> <a href="${CONFIG.ETHERSCAN_BASE_URL}/tx/0x1234567890abcdef" target="_blank" class="hash-link">0x1234567890abcdef</a></p>
                </div>
                <div class="data-item">
                    <h3>💰 交易记录</h3>
                    <p><strong>数据:</strong> {"name": "Alice", "age": 30}</p>
                    <p><strong>金额:</strong> 0.001 ETH</p>
                    <p><strong>Gas 使用:</strong> 21,000</p>
                    <p><strong>时间:</strong> ${new Date(Date.now() - 3600000).toLocaleString()}</p>
                </div>
            `;
        }

        // 添加到数据列表
        function addToDataList(item) {
            const dataList = document.getElementById('dataList');
            const itemHtml = `
                <div class="data-item" style="border-left: 4px solid #667eea;">
                    <h3>${item.type}</h3>
                    <p><strong>数据:</strong> ${item.data.length > 200 ? item.data.substring(0, 200) + '...' : item.data}</p>
                    <p><strong>哈希:</strong> <a href="${CONFIG.ETHERSCAN_BASE_URL}/tx/${item.hash}" target="_blank" class="hash-link">${item.hash.slice(0, 10)}...${item.hash.slice(-8)}</a></p>
                    ${item.amount ? `<p><strong>金额:</strong> ${item.amount}</p>` : ''}
                    ${item.contract ? `<p><strong>合约:</strong> <span class="hash-link">${item.contract.slice(0, 8)}...${item.contract.slice(-6)}</span></p>` : ''}
                    ${item.gasUsed ? `<p><strong>Gas 使用:</strong> ${parseInt(item.gasUsed).toLocaleString()}</p>` : ''}
                    <p><strong>时间:</strong> ${item.timestamp}</p>
                </div>
            `;
            
            if (dataList.innerHTML.includes('查询结果')) {
                const existingContent = dataList.innerHTML;
                dataList.innerHTML = '<h3>📊 最近数据</h3>' + itemHtml + existingContent;
            } else if (dataList.innerHTML.includes('最近数据')) {
                const titleEnd = dataList.innerHTML.indexOf('</h3>') + 5;
                const title = dataList.innerHTML.substring(0, titleEnd);
                const content = dataList.innerHTML.substring(titleEnd);
                dataList.innerHTML = title + itemHtml + content;
            } else {
                dataList.innerHTML = '<h3>📊 最近数据</h3>' + itemHtml + dataList.innerHTML;
            }
        }

        // 切换标签页
        function showTab(tabName) {
            // 隐藏所有标签页内容
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 移除所有标签页按钮的激活状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签页内容
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // 激活对应的标签页按钮
            event.target.classList.add('active');
        }

        // 初始化应用
        async function initializeApp() {
            console.log('🚀 初始化区块链数据上链系统...');
            
            // 检查 Web3 支持
            if (typeof window.ethereum !== 'undefined') {
                console.log('✅ 检测到 MetaMask');
                
                // 检查是否已连接
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('🔗 自动连接钱包...');
                        await connectWallet();
                    }
                } catch (error) {
                    console.log('自动连接失败:', error);
                }
                
                // 监听账户和网络变化
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                
            } else {
                console.log('❌ 未检测到 Web3 钱包');
                showToast('请安装 MetaMask 钱包以使用完整功能', 'error');
            }
            
            console.log('✅ 应用初始化完成');
        }

        // 处理账户变化
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                console.log('🔌 账户已断开');
                disconnectWallet();
            } else if (accounts[0] !== userAddress) {
                console.log('🔄 账户已切换');
                connectWallet();
            }
        }

        // 处理网络变化
        function handleChainChanged(chainId) {
            console.log('🌐 网络已切换:', chainId);
            window.location.reload();
        }

        // 页面加载完成后初始化
        window.addEventListener('load', initializeApp);

        // 添加全局错误处理
        window.addEventListener('error', (event) => {
            console.error('全局错误:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('未处理的 Promise 错误:', event.reason);
        });

        console.log('📋 系统配置:', CONFIG);
    </script>
</body>
</html>