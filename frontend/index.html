                <button class="connect-btn" onclick="disconnectWallet()" style="background: #ff6b6b; padding: 8px 16px;">
                    æ–­å¼€è¿æ¥
                </button>
            `;
        }

        // åŠ è½½ç”¨æˆ·ä½™é¢
        async function loadUserBalances() {
            if (!provider || !userAddress) return;
            
            try {
                // ETH ä½™é¢
                const ethBalance = await provider.getBalance(userAddress);
                const ethFormatted = parseFloat(ethers.formatEther(ethBalance)).toFixed(4);
                
                // USDT ä½™é¢
                let usdtFormatted = "0.00";
                try {
                    const usdtContract = new ethers.Contract(CONFIG.USDT_CONTRACT_ADDRESS, USDT_ABI, provider);
                    const usdtBalance = await usdtContract.balanceOf(userAddress);
                    const decimals = await usdtContract.decimals();
                    usdtFormatted = parseFloat(ethers.formatUnits(usdtBalance, decimals)).toFixed(2);
                } catch (e) {
                    console.log('USDT ä½™é¢æŸ¥è¯¢å¤±è´¥:', e);
                }
                
                // æ›´æ–° UI
                const balanceInfo = document.getElementById('balanceInfo');
                if (balanceInfo) {
                    balanceInfo.innerHTML = `${ethFormatted} ETH | ${usdtFormatted} USDT`;
                }
                
            } catch (error) {
                console.log('ä½™é¢æŸ¥è¯¢å¤±è´¥:', error);
            }
        }

        // æ–­å¼€é’±åŒ…è¿æ¥
        function disconnectWallet() {
            provider = null;
            signer = null;
            contract = null;
            userAddress = null;
            ensName = null;
            ensAvatar = null;
            
            const walletInfo = document.getElementById('walletInfo');
            walletInfo.innerHTML = '<button class="connect-btn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>';
            
            showToast('é’±åŒ…å·²æ–­å¼€è¿æ¥', 'success');
        }

        // æŒ‰é’®åŠ è½½çŠ¶æ€æ§åˆ¶
        function setButtonLoading(buttonElement, loading) {
            if (loading) {
                buttonElement.classList.add('loading');
                buttonElement.disabled = true;
            } else {
                buttonElement.classList.remove('loading');
                buttonElement.disabled = false;
            }
        }

        // ç›´æ¥è½¬è´¦
        async function sendDirectTransaction() {
            if (!signer) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const button = event.target;
            setButtonLoading(button, true);

            try {
                showProgress('ETH è½¬è´¦è¿›è¡Œä¸­...');
                updateProgress(1, 'active', 25);
                
                const address = document.getElementById('directAddress').value.trim();
                const amount = document.getElementById('directAmount').value;
                const data = document.getElementById('directData').value;
                
                // éªŒè¯è¾“å…¥
                if (!address || !ethers.isAddress(address)) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€');
                }
                
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                }
                
                if (!data.trim()) {
                    throw new Error('è¯·è¾“å…¥è¦ä¸Šé“¾çš„æ•°æ®');
                }
                
                updateProgress(2, 'active', 50);
                
                // æ£€æŸ¥ä½™é¢
                const balance = await provider.getBalance(userAddress);
                const amountWei = ethers.parseEther(amount);
                const gasEstimate = ethers.parseEther("0.001");
                
                if (balance < (amountWei + gasEstimate)) {
                    throw new Error('ETH ä½™é¢ä¸è¶³');
                }
                
                // ç¼–ç æ•°æ®
                const encodedData = ethers.hexlify(ethers.toUtf8Bytes(data));
                
                // ä¼°ç®— gas
                const gasLimit = await provider.estimateGas({
                    to: address,
                    value: amountWei,
                    data: encodedData
                });
                
                const tx = await signer.sendTransaction({
                    to: address,
                    value: amountWei,
                    data: encodedData,
                    gasLimit: gasLimit * 120n / 100n // å¢åŠ  20% çš„ gas ç¼“å†²
                });
                
                currentTransaction = tx;
                updateProgress(3, 'active', 75);
                
                const receipt = await tx.wait();
                updateProgress(4, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('âœ… ETH è½¬è´¦æˆåŠŸï¼', 'success');
                    
                    // æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
                    addToDataList({
                        type: 'ETHè½¬è´¦',
                        data: data,
                        hash: tx.hash,
                        amount: amount + ' ETH',
                        timestamp: new Date().toLocaleString(),
                        gasUsed: receipt.gasUsed.toString()
                    });
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('directData').value = '';
                    
                    // æ›´æ–°ä½™é¢
                    loadUserBalances();
                }, 1000);
                
            } catch (error) {
                updateProgress(1, 'failed', 0);
                setTimeout(() => {
                    hideProgress();
                    showToast('è½¬è´¦å¤±è´¥: ' + error.message, 'error');
                }, 1000);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // USDT è½¬è´¦
        async function sendUSDTTransaction() {
            if (!signer) {
                showToast('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }

            const button = event.target;
            setButtonLoading(button, true);

            try {
                showProgress('USDT è½¬è´¦è¿›è¡Œä¸­...');
                updateProgress(1, 'active', 25);
                
                const address = document.getElementById('usdtAddress').value.trim();
                const amount = document.getElementById('usdtAmount').value;
                const data = document.getElementById('usdtData').value;
                const tokenType = document.getElementById('tokenSelect').value;
                
                // éªŒè¯è¾“å…¥
                if (!address || !ethers.isAddress(address)) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„ä»¥å¤ªåŠåœ°å€');
                }
                
                if (!amount || parseFloat(amount) <= 0) {
                    throw new Error('è¯·è¾“å…¥æœ‰æ•ˆçš„è½¬è´¦é‡‘é¢');
                }
                
                updateProgress(2, 'active', 50);
                
                let tokenAddress = CONFIG.USDT_CONTRACT_ADDRESS;
                let decimals = 6;
                
                const tokenContract = new ethers.Contract(tokenAddress, USDT_ABI, signer);
                
                // æ£€æŸ¥ä»£å¸ä½™é¢
                const balance = await tokenContract.balanceOf(userAddress);
                const amountInWei = ethers.parseUnits(amount, decimals);
                
                if (balance < amountInWei) {
                    throw new Error(`${tokenType} ä½™é¢ä¸è¶³`);
                }
                
                // ä¼°ç®— gas
                let gasLimit;
                try {
                    gasLimit = await tokenContract.transfer.estimateGas(address, amountInWei);
                } catch (e) {
                    gasLimit = 100000n;
                }
                
                const tx = await tokenContract.transfer(address, amountInWei, {
                    gasLimit: gasLimit * 120n / 100n
                });
                
                currentTransaction = tx;
                updateProgress(3, 'active', 75);
                
                const receipt = await tx.wait();
                updateProgress(4, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast(`âœ… ${tokenType} è½¬è´¦æˆåŠŸï¼`, 'success');
                    
                    // æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
                    addToDataList({
                        type: tokenType + 'è½¬è´¦',
                        data: data || 'è½¬è´¦æ•°æ®',
                        hash: tx.hash,
                        amount: amount + ' ' + tokenType,
                        timestamp: new Date().toLocaleString(),
                        gasUsed: receipt.gasUsed.toString()
                    });
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('usdtData').value = '';
                    
                    // æ›´æ–°ä½™é¢
                    loadUserBalances();
                }, 1000);
                
            } catch (error) {
                updateProgress(1, 'failed', 0);
                setTimeout(() => {
                    hideProgress();
                    showToast('USDT è½¬è´¦å¤±è´¥: ' + error.message, 'error');
                }, 1000);
            } finally {
                setButtonLoading(button, false);
            }
        }

        // éƒ¨ç½²åˆçº¦
        async function deployContract() {
            showToast('åˆçº¦éƒ¨ç½²åŠŸèƒ½éœ€è¦å®é™…çš„åˆçº¦å­—èŠ‚ç ï¼Œå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼', 'info');
            
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('åˆçº¦éƒ¨ç½²ä¸­...');
            updateProgress(1, 'active', 25);
            
            // æ¨¡æ‹Ÿéƒ¨ç½²è¿‡ç¨‹
            setTimeout(() => {
                updateProgress(2, 'active', 50);
            }, 1000);
            
            setTimeout(() => {
                updateProgress(3, 'active', 75);
            }, 2000);
            
            setTimeout(() => {
                updateProgress(4, 'completed', 100);
                const mockAddress = "0x" + Math.random().toString(16).substr(2, 40);
                document.getElementById('contractAddress').value = mockAddress;
                
                setTimeout(() => {
                    hideProgress();
                    showToast('âœ… åˆçº¦éƒ¨ç½²æˆåŠŸï¼ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰', 'success');
                    setButtonLoading(button, false);
                }, 500);
            }, 3000);
        }

        // å­˜å‚¨æ•°æ®åˆ°åˆçº¦
        async function storeDataInContract() {
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('å†™å…¥åˆçº¦æ•°æ®ä¸­...');
            updateProgress(1, 'active', 25);
            
            const data = document.getElementById('contractData').value.trim();
            const dataType = document.getElementById('dataType').value;
            
            if (!data) {
                hideProgress();
                showToast('è¯·è¾“å…¥è¦å­˜å‚¨çš„æ•°æ®', 'error');
                setButtonLoading(button, false);
                return;
            }
            
            // æ¨¡æ‹Ÿåˆçº¦å†™å…¥
            setTimeout(() => {
                updateProgress(2, 'active', 50);
            }, 500);
            
            setTimeout(() => {
                updateProgress(3, 'active', 75);
            }, 1500);
            
            setTimeout(() => {
                updateProgress(4, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('âœ… æ•°æ®å†™å…¥æˆåŠŸï¼ï¼ˆæ¼”ç¤ºæ¨¡å¼ï¼‰', 'success');
                    
                    // æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
                    const mockTxHash = "0x" + Math.random().toString(16).substr(2, 64);
                    addToDataList({
                        type: 'åˆçº¦æ•°æ®ï¼ˆæ¼”ç¤ºï¼‰',
                        data: data,
                        hash: mockTxHash,
                        contract: document.getElementById('contractAddress').value || 'demo-contract',
                        timestamp: new Date().toLocaleString(),
                        gasUsed: '50000'
                    });
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('contractData').value = '';
                    setButtonLoading(button, false);
                }, 500);
            }, 2500);
        }

        // æŸ¥è¯¢æ•°æ®ï¼ˆç®€åŒ–ç‰ˆï¼‰
        async function queryData() {
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('æŸ¥è¯¢æ•°æ®ä¸­...');
            updateProgress(1, 'active', 50);
            
            // æ¨¡æ‹ŸæŸ¥è¯¢
            setTimeout(() => {
                updateProgress(2, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('æŸ¥è¯¢å®Œæˆï¼', 'success');
                    
                    // æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®
                    displayDemoResults();
                    setButtonLoading(button, false);
                }, 500);
            }, 1500);
        }

        // The Graph æŸ¥è¯¢
        async function queryTheGraph() {
            const button = event.target;
            setButtonLoading(button, true);
            
            showProgress('æ‰§è¡Œ GraphQL æŸ¥è¯¢...');
            updateProgress(1, 'active', 50);
            
            // æ¨¡æ‹ŸæŸ¥è¯¢
            setTimeout(() => {
                updateProgress(2, 'completed', 100);
                
                setTimeout(() => {
                    hideProgress();
                    showToast('The Graph æŸ¥è¯¢æˆåŠŸï¼', 'success');
                    
                    // æ˜¾ç¤ºæ¼”ç¤ºæ•°æ®
                    displayDemoResults();
                    setButtonLoading(button, false);
                }, 500);
            }, 2000);
        }

        // æ˜¾ç¤ºæ¼”ç¤ºç»“æœ
        function displayDemoResults() {
            const dataList = document.getElementById('dataList');
            dataList.innerHTML = `
                <h3>ğŸ“Š æŸ¥è¯¢ç»“æœ</h3>
                <div class="data-item">
                    <h3>ğŸ”— åˆçº¦æ•°æ®è®°å½•</h3>
                    <p><strong>æ•°æ®:</strong> æ¼”ç¤ºæ•°æ®ï¼šç”¨æˆ·æ³¨å†Œä¿¡æ¯</p>
                    <p><strong>æ—¶é—´:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>åŒºå—:</strong> 12345678</p>
                    <p><strong>äº¤æ˜“å“ˆå¸Œ:</strong> <a href="${CONFIG.ETHERSCAN_BASE_URL}/tx/0x1234567890abcdef" target="_blank" class="hash-link">0x1234567890abcdef</a></p>
                </div>
                <div class="data-item">
                    <h3>ğŸ’° äº¤æ˜“è®°å½•</h3>
                    <p><strong>æ•°æ®:</strong> {"name": "Alice", "age": 30}</p>
                    <p><strong>é‡‘é¢:</strong> 0.001 ETH</p>
                    <p><strong>Gas ä½¿ç”¨:</strong> 21,000</p>
                    <p><strong>æ—¶é—´:</strong> ${new Date(Date.now() - 3600000).toLocaleString()}</p>
                </div>
            `;
        }

        // æ·»åŠ åˆ°æ•°æ®åˆ—è¡¨
        function addToDataList(item) {
            const dataList = document.getElementById('dataList');
            const itemHtml = `
                <div class="data-item" style="border-left: 4px solid #667eea;">
                    <h3>${item.type}</h3>
                    <p><strong>æ•°æ®:</strong> ${item.data.length > 200 ? item.data.substring(0, 200) + '...' : item.data}</p>
                    <p><strong>å“ˆå¸Œ:</strong> <a href="${CONFIG.ETHERSCAN_BASE_URL}/tx/${item.hash}" target="_blank" class="hash-link">${item.hash.slice(0, 10)}...${item.hash.slice(-8)}</a></p>
                    ${item.amount ? `<p><strong>é‡‘é¢:</strong> ${item.amount}</p>` : ''}
                    ${item.contract ? `<p><strong>åˆçº¦:</strong> <span class="hash-link">${item.contract.slice(0, 8)}...${item.contract.slice(-6)}</span></p>` : ''}
                    ${item.gasUsed ? `<p><strong>Gas ä½¿ç”¨:</strong> ${parseInt(item.gasUsed).toLocaleString()}</p>` : ''}
                    <p><strong>æ—¶é—´:</strong> ${item.timestamp}</p>
                </div>
            `;
            
            if (dataList.innerHTML.includes('æŸ¥è¯¢ç»“æœ')) {
                const existingContent = dataList.innerHTML;
                dataList.innerHTML = '<h3>ğŸ“Š æœ€è¿‘æ•°æ®</h3>' + itemHtml + existingContent;
            } else if (dataList.innerHTML.includes('æœ€è¿‘æ•°æ®')) {
                const titleEnd = dataList.innerHTML.indexOf('</h3>') + 5;
                const title = dataList.innerHTML.substring(0, titleEnd);
                const content = dataList.innerHTML.substring(titleEnd);
                dataList.innerHTML = title + itemHtml + content;
            } else {
                dataList.innerHTML = '<h3>ğŸ“Š æœ€è¿‘æ•°æ®</h3>' + itemHtml + dataList.innerHTML;
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ
        function showTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µå†…å®¹
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾é¡µæŒ‰é’®
            event.target.classList.add('active');
        }

        // åˆå§‹åŒ–åº”ç”¨
        async function initializeApp() {
            console.log('ğŸš€ åˆå§‹åŒ–åŒºå—é“¾æ•°æ®ä¸Šé“¾ç³»ç»Ÿ...');
            
            // æ£€æŸ¥ Web3 æ”¯æŒ
            if (typeof window.ethereum !== 'undefined') {
                console.log('âœ… æ£€æµ‹åˆ° MetaMask');
                
                // æ£€æŸ¥æ˜¯å¦å·²è¿æ¥
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('ğŸ”— è‡ªåŠ¨è¿æ¥é’±åŒ…...');
                        await connectWallet();
                    }
                } catch (error) {
                    console.log('è‡ªåŠ¨è¿æ¥å¤±è´¥:', error);
                }
                
                // ç›‘å¬è´¦æˆ·å’Œç½‘ç»œå˜åŒ–
                window.ethereum.on('accountsChanged', handleAccountsChanged);
                window.ethereum.on('chainChanged', handleChainChanged);
                
            } else {
                console.log('âŒ æœªæ£€æµ‹åˆ° Web3 é’±åŒ…');
                showToast('è¯·å®‰è£… MetaMask é’±åŒ…ä»¥ä½¿ç”¨å®Œæ•´åŠŸèƒ½', 'error');
            }
            
            console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        function handleAccountsChanged(accounts) {
            if (accounts.length === 0) {
                console.log('ğŸ”Œ è´¦æˆ·å·²æ–­å¼€');
                disconnectWallet();
            } else if (accounts[0] !== userAddress) {
                console.log('ğŸ”„ è´¦æˆ·å·²åˆ‡æ¢');
                connectWallet();
            }
        }

        // å¤„ç†ç½‘ç»œå˜åŒ–
        function handleChainChanged(chainId) {
            console.log('ğŸŒ ç½‘ç»œå·²åˆ‡æ¢:', chainId);
            window.location.reload();
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', initializeApp);

        // æ·»åŠ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (event) => {
            console.error('å…¨å±€é”™è¯¯:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('æœªå¤„ç†çš„ Promise é”™è¯¯:', event.reason);
        });

        console.log('ğŸ“‹ ç³»ç»Ÿé…ç½®:', CONFIG);
    </script>
</body>
</html>