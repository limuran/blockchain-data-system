<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¢å¼ºç‰ˆä»£å¸è½¬è´¦ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .header {
            text-align: center;
            margin-bottom: 32px;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0 0 8px 0;
            font-size: 28px;
        }
        .header p {
            color: #7f8c8d;
            margin: 0;
            font-size: 16px;
        }
        .token-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .token-button {
            padding: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
        }
        .token-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .token-button.selected {
            border-color: #4CAF50;
            background: #f1f8e9;
        }
        .balance-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
            border: 1px solid #e9ecef;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #2c3e50;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-top: 8px;
            display: none;
        }
        .submit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
        }
        .submit-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .connect-btn {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-bottom: 20px;
        }
        .status-message {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin: 16px 0;
            font-weight: bold;
        }
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .features {
            background: #e3f2fd;
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
            border: 1px solid #bbdefb;
        }
        .features h4 {
            margin: 0 0 12px 0;
            color: #1976d2;
        }
        .features ul {
            margin: 0;
            padding-left: 20px;
            color: #424242;
        }
        .features li {
            margin-bottom: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª™ å¢å¼ºç‰ˆä»£å¸è½¬è´¦ç³»ç»Ÿ</h1>
            <p>æ”¯æŒå¤šç§ç¨³å®šå¸ï¼Œè‡ªåŠ¨ETHå…‘æ¢ï¼Œæ™ºèƒ½åˆçº¦æˆæƒ</p>
        </div>

        <div id="wallet-section">
            <button id="connect-btn" class="connect-btn" onclick="connectWallet()">
                è¿æ¥é’±åŒ…
            </button>
        </div>

        <div id="transfer-section" style="display: none;">
            <!-- ä»£å¸é€‰æ‹© -->
            <div class="form-group">
                <label>ğŸ·ï¸ é€‰æ‹©ä»£å¸</label>
                <div id="token-grid" class="token-grid">
                    <!-- åŠ¨æ€ç”Ÿæˆä»£å¸é€‰é¡¹ -->
                </div>
            </div>

            <!-- é’±åŒ…ä½™é¢ -->
            <div class="balance-card">
                <h4 style="margin: 0 0 12px 0;">ğŸ’³ é’±åŒ…ä½™é¢</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                    <div>
                        <span style="color: #666;">ETH: </span>
                        <span id="eth-balance" style="font-weight: bold;">0.000000</span>
                    </div>
                    <div>
                        <span style="color: #666;"><span id="selected-token-name">USDT</span>: </span>
                        <span id="token-balance" style="font-weight: bold;">0.000000</span>
                    </div>
                </div>
            </div>

            <form onsubmit="handleSubmit(event)">
                <!-- è½¬è´¦åœ°å€ -->
                <div class="form-group">
                    <label>ğŸ“ è½¬è´¦åœ°å€</label>
                    <input type="text" id="recipient-address" placeholder="0x..." required style="font-family: monospace;">
                </div>

                <!-- è½¬è´¦é‡‘é¢ -->
                <div class="form-group">
                    <label>ğŸ’° è½¬è´¦é‡‘é¢ (<span id="amount-token-name">USDT</span>)</label>
                    <input type="number" id="transfer-amount" value="1.0" step="0.000001" min="0" required onchange="checkBalance()">
                    
                    <!-- ä½™é¢ä¸è¶³è­¦å‘Š -->
                    <div id="swap-warning" class="warning-box">
                        <div style="font-weight: bold; margin-bottom: 8px;">âš ï¸ ä½™é¢ä¸å¤Ÿï¼</div>
                        <div id="swap-message" style="font-size: 14px;"></div>
                    </div>
                </div>

                <!-- è½¬è´¦ä¿¡æ¯ -->
                <div class="form-group">
                    <label>ğŸ“„ è½¬è´¦ä¿¡æ¯</label>
                    <textarea id="transfer-data" rows="3" placeholder="è¾“å…¥è½¬è´¦ç›¸å…³ä¿¡æ¯...">è®¢å•ç¼–å·:ORD1725523200000 ä»˜æ¬¾ç±»å‹:æœåŠ¡è´¹ Service payment for order</textarea>
                    <small style="color: #666; font-size: 12px;">ğŸ’¡ ç”±äºè¿™æ˜¯åˆçº¦è½¬è´¦ï¼Œè½¬è´¦ä¿¡æ¯å°†è®°å½•åœ¨åŒºå—é“¾ä¸Š</small>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button type="submit" id="submit-btn" class="submit-btn">
                    ğŸ’¸ å‘é€è½¬è´¦
                </button>
            </form>

            <!-- çŠ¶æ€æ¶ˆæ¯ -->
            <div id="status-message" style="display: none;"></div>

            <!-- åŠŸèƒ½è¯´æ˜ -->
            <div class="features">
                <h4>ğŸ’¡ åŠŸèƒ½è¯´æ˜</h4>
                <ul>
                    <li>æ”¯æŒå¤šç§ç¨³å®šå¸è½¬è´¦ï¼ˆUSDTã€USDCã€DAIç­‰ï¼‰</li>
                    <li>ä½™é¢ä¸è¶³æ—¶è‡ªåŠ¨æç¤ºETHå…‘æ¢é€‰é¡¹</li>
                    <li>æ™ºèƒ½æ£€æµ‹å¹¶å¤„ç†ERC20ä»£å¸æˆæƒ</li>
                    <li>è½¬è´¦ä¿¡æ¯å°†æ°¸ä¹…è®°å½•åœ¨åŒºå—é“¾ä¸Š</li>
                </ul>
            </div>
        </div>
    </div>

    <script type="module">
        import { ethers } from 'https://cdn.skypack.dev/ethers@6.8.0';
        
        // å…¨å±€å˜é‡
        window.wallet = { address: null, chainId: null };
        window.balances = {};
        window.ethBalance = '0.000000';
        window.selectedToken = 'USDT';
        window.swapQuote = null;
        window.loading = false;

        // ä»£å¸é…ç½®
        const SUPPORTED_TOKENS = {
            1: {
                USDT: { address: '0xdAC17F958D2ee523a2206206994597C13D831ec7', decimals: 6, symbol: 'USDT', name: 'Tether USD', icon: 'ğŸ”—', type: 'ERC20' },
                USDC: { address: '0xA0b86a33E6441E3b4Ca9BbD61D0b01faa9602C81', decimals: 6, symbol: 'USDC', name: 'USD Coin', icon: 'ğŸ”µ', type: 'ERC20' },
                DAI: { address: '0x6B175474E89094C44Da98b954EedeAC495271d0F', decimals: 18, symbol: 'DAI', name: 'Dai Stablecoin', icon: 'ğŸŸ¡', type: 'ERC20' }
            },
            11155111: {
                USDT: { address: '0x7169D38820dfd117C3FA1f22a697dBA58d90BA06', decimals: 6, symbol: 'USDT', name: 'Tether USD (Sepolia)', icon: 'ğŸ”—', type: 'ERC20' },
                USDC: { address: '0x94a9D9AC8a22534E3FaCa9F4e7F2E2cf85d5E4C8', decimals: 6, symbol: 'USDC', name: 'USD Coin (Sepolia)', icon: 'ğŸ”µ', type: 'ERC20' }
            }
        };

        const ERC20_ABI = [
            'function transfer(address to, uint256 amount) external returns (bool)',
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function allowance(address owner, address spender) external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)',
            'function decimals() external view returns (uint8)'
        ];

        // è¿æ¥é’±åŒ…
        window.connectWallet = async function() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    const provider = new ethers.BrowserProvider(window.ethereum);
                    const network = await provider.getNetwork();
                    
                    window.wallet = { 
                        address: accounts[0], 
                        chainId: Number(network.chainId) 
                    };
                    
                    document.getElementById('wallet-section').style.display = 'none';
                    document.getElementById('transfer-section').style.display = 'block';
                    
                    await initializeTokens();
                    await fetchBalances();
                    
                } catch (error) {
                    showMessage('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
                }
            } else {
                showMessage('è¯·å®‰è£…MetaMaské’±åŒ…', 'error');
            }
        };

        // åˆå§‹åŒ–ä»£å¸é€‰æ‹©
        async function initializeTokens() {
            const supportedTokens = SUPPORTED_TOKENS[window.wallet.chainId] || {};
            const tokenGrid = document.getElementById('token-grid');
            
            if (Object.keys(supportedTokens).length === 0) {
                tokenGrid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #666;">å½“å‰ç½‘ç»œä¸æ”¯æŒä»£å¸è½¬è´¦</div>';
                return;
            }
            
            tokenGrid.innerHTML = Object.entries(supportedTokens).map(([symbol, token]) => `
                <div class="token-button ${window.selectedToken === symbol ? 'selected' : ''}" onclick="selectToken('${symbol}')">
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                        <span style="font-size: 20px; margin-right: 8px;">${token.icon}</span>
                        <span style="font-weight: bold;">${symbol}</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 4px;">${token.name}</div>
                    <div style="font-size: 14px; font-weight: bold; color: #4CAF50;" id="balance-${symbol}">
                        0.000000
                    </div>
                </div>
            `).join('');
        }

        // é€‰æ‹©ä»£å¸
        window.selectToken = function(symbol) {
            window.selectedToken = symbol;
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.token-button').forEach(btn => btn.classList.remove('selected'));
            event.target.closest('.token-button').classList.add('selected');
            
            // æ›´æ–°æ˜¾ç¤º
            document.getElementById('selected-token-name').textContent = symbol;
            document.getElementById('amount-token-name').textContent = symbol;
            document.getElementById('token-balance').textContent = window.balances[symbol] || '0.000000';
            
            checkBalance();
        };

        // è·å–ä½™é¢
        async function fetchBalances() {
            if (!window.wallet.address) return;
            
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const supportedTokens = SUPPORTED_TOKENS[window.wallet.chainId] || {};
                
                // è·å–ETHä½™é¢
                const balance = await provider.getBalance(window.wallet.address);
                window.ethBalance = parseFloat(ethers.formatEther(balance)).toFixed(6);
                document.getElementById('eth-balance').textContent = window.ethBalance;
                
                // è·å–ä»£å¸ä½™é¢
                for (const [symbol, token] of Object.entries(supportedTokens)) {
                    try {
                        const contract = new ethers.Contract(token.address, ERC20_ABI, provider);
                        const tokenBalance = await contract.balanceOf(window.wallet.address);
                        const formatted = parseFloat(ethers.formatUnits(tokenBalance, token.decimals)).toFixed(6);
                        
                        window.balances[symbol] = formatted;
                        
                        const balanceEl = document.getElementById(`balance-${symbol}`);
                        if (balanceEl) balanceEl.textContent = formatted;
                        
                        if (symbol === window.selectedToken) {
                            document.getElementById('token-balance').textContent = formatted;
                        }
                    } catch (error) {
                        console.error(`è·å–${symbol}ä½™é¢å¤±è´¥:`, error);
                        window.balances[symbol] = '0.000000';
                    }
                }
                
                checkBalance();
                
            } catch (error) {
                console.error('è·å–ä½™é¢å¤±è´¥:', error);
            }
        }

        // æ£€æŸ¥ä½™é¢
        window.checkBalance = function() {
            const amount = parseFloat(document.getElementById('transfer-amount').value || '0');
            const available = parseFloat(window.balances[window.selectedToken] || '0');
            const warningBox = document.getElementById('swap-warning');
            
            if (amount > available) {
                warningBox.style.display = 'block';
                document.getElementById('swap-message').innerHTML = 
                    '<span style="color: #d32f2f;">âŒ ä½™é¢ä¸è¶³ï¼å½“å‰åŠŸèƒ½ä»…æ”¯æŒç›´æ¥è½¬è´¦</span>';
            } else {
                warningBox.style.display = 'none';
            }
        };

        // å¤„ç†æäº¤
        window.handleSubmit = async function(event) {
            event.preventDefault();
            
            if (window.loading) return;
            
            const supportedTokens = SUPPORTED_TOKENS[window.wallet.chainId] || {};
            const currentToken = supportedTokens[window.selectedToken];
            
            if (!currentToken) {
                showMessage('å½“å‰ç½‘ç»œä¸æ”¯æŒæ‰€é€‰ä»£å¸', 'error');
                return;
            }
            
            const recipientAddress = document.getElementById('recipient-address').value;
            const amount = document.getElementById('transfer-amount').value;
            const data = document.getElementById('transfer-data').value;
            
            if (!recipientAddress || !amount) {
                showMessage('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'error');
                return;
            }
            
            const required = parseFloat(amount);
            const available = parseFloat(window.balances[window.selectedToken] || '0');
            
            if (required > available) {
                showMessage('ä½™é¢ä¸è¶³', 'error');
                return;
            }
            
            await executeTransfer(currentToken, recipientAddress, amount, data);
        };

        // æ‰§è¡Œè½¬è´¦
        async function executeTransfer(token, to, amount, data) {
            window.loading = true;
            updateLoadingState('æ‰§è¡Œä»£å¸è½¬è´¦...');
            
            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const amountWei = ethers.parseUnits(amount, token.decimals);
                
                const contract = new ethers.Contract(token.address, ERC20_ABI, signer);
                const tx = await contract.transfer(to, amountWei);
                
                updateLoadingState('ç­‰å¾…äº¤æ˜“ç¡®è®¤...');
                const receipt = await tx.wait();
                
                showMessage(`âœ… è½¬è´¦æˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ${tx.hash}`, 'success');
                
                // åˆ·æ–°ä½™é¢
                setTimeout(() => {
                    fetchBalances();
                }, 2000);
                
            } catch (error) {
                showMessage('è½¬è´¦å¤±è´¥: ' + error.message, 'error');
            } finally {
                window.loading = false;
                updateLoadingState();
            }
        }

        // æ›´æ–°åŠ è½½çŠ¶æ€
        function updateLoadingState(message = '') {
            const submitBtn = document.getElementById('submit-btn');
            if (window.loading) {
                submitBtn.disabled = true;
                submitBtn.textContent = message || 'å¤„ç†ä¸­...';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = 'ğŸ’¸ å‘é€è½¬è´¦';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageEl = document.getElementById('status-message');
            messageEl.className = `status-message status-${type}`;
            messageEl.textContent = message;
            messageEl.style.display = 'block';
            
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }

        // åˆå§‹åŒ–è½¬è´¦æ•°æ®
        document.addEventListener('DOMContentLoaded', () => {
            const now = Date.now();
            document.getElementById('transfer-data').value = 
                `è®¢å•ç¼–å·:ORD${now} ä»˜æ¬¾ç±»å‹:æœåŠ¡è´¹ Service payment for order`;
        });
    </script>
</body>
</html>